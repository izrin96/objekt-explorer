FROM oven/bun:slim AS base
WORKDIR /app

# prune monorepo
FROM base AS prune
COPY . .
RUN bun install turbo --global
ENV TURBO_TELEMETRY_DISABLED=1
RUN turbo prune web --docker

# dependencies & build
FROM base AS build
COPY --from=prune /app/out/json/ .
RUN bun install --frozen-lockfile
COPY --from=prune /app/out/full/ .

ARG NEXT_PUBLIC_UMAMI_SCRIPT_URL
ARG NEXT_PUBLIC_UMAMI_WEBSITE_ID
ARG NEXT_PUBLIC_ACTIVITY_WEBSOCKET_URL
ARG BETTER_AUTH_SECRET
ARG DISCORD_CLIENT_ID
ARG DISCORD_CLIENT_SECRET
ARG TWITTER_CLIENT_ID
ARG TWITTER_CLIENT_SECRET
ARG BROWSER_CDP_URL
ARG NEXT_PUBLIC_SITE_URL
ARG DATABASE_URL
ARG INDEXER_DATABASE_URL
ARG S3_ENDPOINT
ARG S3_ACCESS_KEY
ARG S3_SECRET_KEY
ARG SES_REGION
ARG SES_ACCESS_KEY
ARG SES_SECRET_KEY
ARG SES_MAIL_FROM
ARG NEXT_PUBLIC_LIVE_API_KEY
ARG BYPASS_LIVE_KEY
ARG REDIS_URL

ENV NEXT_TELEMETRY_DISABLED=1
ENV TURBO_TELEMETRY_DISABLED=1
ENV NEXT_PUBLIC_UMAMI_SCRIPT_URL=$NEXT_PUBLIC_UMAMI_SCRIPT_URL
ENV NEXT_PUBLIC_UMAMI_WEBSITE_ID=$NEXT_PUBLIC_UMAMI_WEBSITE_ID
ENV NEXT_PUBLIC_ACTIVITY_WEBSOCKET_URL=$NEXT_PUBLIC_ACTIVITY_WEBSOCKET_URL
ENV BETTER_AUTH_SECRET=$BETTER_AUTH_SECRET
ENV DISCORD_CLIENT_ID=$DISCORD_CLIENT_ID
ENV DISCORD_CLIENT_SECRET=$DISCORD_CLIENT_SECRET
ENV TWITTER_CLIENT_ID=$TWITTER_CLIENT_ID
ENV TWITTER_CLIENT_SECRET=$TWITTER_CLIENT_SECRET
ENV BROWSER_CDP_URL=$BROWSER_CDP_URL
ENV NEXT_PUBLIC_SITE_URL=$NEXT_PUBLIC_SITE_URL
ENV DATABASE_URL=$DATABASE_URL
ENV INDEXER_DATABASE_URL=$INDEXER_DATABASE_URL
ENV S3_ENDPOINT=$S3_ENDPOINT
ENV S3_ACCESS_KEY=$S3_ACCESS_KEY
ENV S3_SECRET_KEY=$S3_SECRET_KEY
ENV SES_REGION=$SES_REGION
ENV SES_ACCESS_KEY=$SES_ACCESS_KEY
ENV SES_SECRET_KEY=$SES_SECRET_KEY
ENV SES_MAIL_FROM=$SES_MAIL_FROM
ENV NEXT_PUBLIC_LIVE_API_KEY=$NEXT_PUBLIC_LIVE_API_KEY
ENV BYPASS_LIVE_KEY=$BYPASS_LIVE_KEY
ENV REDIS_URL=$REDIS_URL

RUN bun run --filter web build:prod

# runner
FROM base AS runner

# Install curl for healthchecks
RUN apt-get update && apt-get install -y curl && rm -rf /var/lib/apt/lists/*

ENV NODE_ENV=production
ENV NEXT_TELEMETRY_DISABLED=1

COPY --from=build /app/apps/web/.next/standalone ./
COPY --from=build /app/apps/web/.next/static ./apps/web/.next/static
COPY --from=build /app/apps/web/public ./apps/web/public

EXPOSE 3000/tcp

CMD ["bun", "run", "--bun", "apps/web/server.js"]