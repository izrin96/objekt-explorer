FROM node:24-alpine AS base
WORKDIR /app
RUN apk update
RUN apk add --no-cache libc6-compat

FROM base AS pnpm
RUN corepack enable
RUN pnpm config set store-dir ~/.pnpm-store

FROM pnpm AS prune
RUN npm install -g turbo@latest
COPY . .
ENV TURBO_TELEMETRY_DISABLED=1
RUN turbo prune web --docker

# build
FROM pnpm AS build
COPY --from=prune /app/out/json/ .
RUN --mount=type=cache,id=pnpm,target=~/.pnpm-store \
    pnpm install --frozen-lockfile

ARG NEXT_PUBLIC_UMAMI_SCRIPT_URL
ARG NEXT_PUBLIC_UMAMI_WEBSITE_ID
ARG NEXT_PUBLIC_ACTIVITY_WEBSOCKET_URL
ARG BETTER_AUTH_SECRET
ARG DISCORD_CLIENT_ID
ARG DISCORD_CLIENT_SECRET
ARG TWITTER_CLIENT_ID
ARG TWITTER_CLIENT_SECRET
ARG BROWSER_CDP_URL
ARG NEXT_PUBLIC_SITE_URL
ARG DATABASE_URL
ARG INDEXER_DATABASE_URL
ARG S3_ENDPOINT
ARG S3_ACCESS_KEY
ARG S3_SECRET_KEY
ARG SES_REGION
ARG SES_ACCESS_KEY
ARG SES_SECRET_KEY
ARG SES_MAIL_FROM
ARG NEXT_PUBLIC_LIVE_API_KEY
ARG BYPASS_LIVE_KEY
ARG NEXT_PUBLIC_PRIVY_APP_ID
ARG PRIVY_APP_SECRET
ARG REDIS_URL

ENV NEXT_TELEMETRY_DISABLED=1
ENV TURBO_TELEMETRY_DISABLED=1
ENV NEXT_PUBLIC_UMAMI_SCRIPT_URL=$NEXT_PUBLIC_UMAMI_SCRIPT_URL
ENV NEXT_PUBLIC_UMAMI_WEBSITE_ID=$NEXT_PUBLIC_UMAMI_WEBSITE_ID
ENV NEXT_PUBLIC_ACTIVITY_WEBSOCKET_URL=$NEXT_PUBLIC_ACTIVITY_WEBSOCKET_URL
ENV BETTER_AUTH_SECRET=$BETTER_AUTH_SECRET
ENV DISCORD_CLIENT_ID=$DISCORD_CLIENT_ID
ENV DISCORD_CLIENT_SECRET=$DISCORD_CLIENT_SECRET
ENV TWITTER_CLIENT_ID=$TWITTER_CLIENT_ID
ENV TWITTER_CLIENT_SECRET=$TWITTER_CLIENT_SECRET
ENV BROWSER_CDP_URL=$BROWSER_CDP_URL
ENV NEXT_PUBLIC_SITE_URL=$NEXT_PUBLIC_SITE_URL
ENV DATABASE_URL=$DATABASE_URL
ENV INDEXER_DATABASE_URL=$INDEXER_DATABASE_URL
ENV S3_ENDPOINT=$S3_ENDPOINT
ENV S3_ACCESS_KEY=$S3_ACCESS_KEY
ENV S3_SECRET_KEY=$S3_SECRET_KEY
ENV SES_REGION=$SES_REGION
ENV SES_ACCESS_KEY=$SES_ACCESS_KEY
ENV SES_SECRET_KEY=$SES_SECRET_KEY
ENV SES_MAIL_FROM=$SES_MAIL_FROM
ENV NEXT_PUBLIC_LIVE_API_KEY=$NEXT_PUBLIC_LIVE_API_KEY
ENV BYPASS_LIVE_KEY=$BYPASS_LIVE_KEY
ENV NEXT_PUBLIC_PRIVY_APP_ID=$NEXT_PUBLIC_PRIVY_APP_ID
ENV PRIVY_APP_SECRET=$PRIVY_APP_SECRET
ENV REDIS_URL=$REDIS_URL

COPY --from=prune /app/out/full/ .
RUN pnpm run build

# runner
FROM base AS runner

ENV NODE_ENV=production
ENV NEXT_TELEMETRY_DISABLED=1

RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs
USER nextjs

COPY --from=build --chown=nextjs:nodejs /app/apps/web/.next/standalone ./
COPY --from=build --chown=nextjs:nodejs /app/apps/web/.next/static ./apps/web/.next/static
COPY --from=build --chown=nextjs:nodejs /app/apps/web/public ./apps/web/public

EXPOSE 3000/tcp

CMD ["node", "apps/web/server.js"]