FROM node:24-alpine AS base
WORKDIR /app
RUN apk update
RUN apk add --no-cache libc6-compat

FROM base AS pnpm
RUN corepack enable
RUN pnpm config set store-dir ~/.pnpm-store

FROM pnpm AS prune
RUN npm install -g turbo@latest
COPY . .
ENV TURBO_TELEMETRY_DISABLED=1
RUN turbo prune web-v2 --docker

# prod and dev dependencies
FROM pnpm AS dev
COPY --from=prune /app/out/json/ .
RUN --mount=type=cache,id=pnpm,target=~/.pnpm-store \
    pnpm install --frozen-lockfile

# prod only dependencies
FROM dev AS prod
ENV CI=true
RUN --mount=type=cache,id=pnpm,target=~/.pnpm-store \
    pnpm install --frozen-lockfile --prod

# build
FROM dev AS build
ARG VITE_UMAMI_SCRIPT_URL
ARG VITE_UMAMI_WEBSITE_ID
ARG VITE_ACTIVITY_WEBSOCKET_URL
ARG BETTER_AUTH_SECRET
ARG DISCORD_CLIENT_ID
ARG DISCORD_CLIENT_SECRET
ARG TWITTER_CLIENT_ID
ARG TWITTER_CLIENT_SECRET
ARG BROWSER_CDP_URL
ARG VITE_SITE_URL
ARG DATABASE_URL
ARG INDEXER_DATABASE_URL
ARG S3_ENDPOINT
ARG S3_ACCESS_KEY
ARG S3_SECRET_KEY
ARG SES_REGION
ARG SES_ACCESS_KEY
ARG SES_SECRET_KEY
ARG SES_MAIL_FROM
ARG VITE_LIVE_API_KEY
ARG BYPASS_LIVE_KEY
ARG VITE_PRIVY_APP_ID
ARG PRIVY_APP_SECRET
ARG REDIS_URL

ENV TURBO_TELEMETRY_DISABLED=1
ENV NODE_OPTIONS="--max-old-space-size=8096"
ENV VITE_UMAMI_SCRIPT_URL=$VITE_UMAMI_SCRIPT_URL
ENV VITE_UMAMI_WEBSITE_ID=$VITE_UMAMI_WEBSITE_ID
ENV VITE_ACTIVITY_WEBSOCKET_URL=$VITE_ACTIVITY_WEBSOCKET_URL
ENV BETTER_AUTH_SECRET=$BETTER_AUTH_SECRET
ENV DISCORD_CLIENT_ID=$DISCORD_CLIENT_ID
ENV DISCORD_CLIENT_SECRET=$DISCORD_CLIENT_SECRET
ENV TWITTER_CLIENT_ID=$TWITTER_CLIENT_ID
ENV TWITTER_CLIENT_SECRET=$TWITTER_CLIENT_SECRET
ENV BROWSER_CDP_URL=$BROWSER_CDP_URL
ENV VITE_SITE_URL=$VITE_SITE_URL
ENV DATABASE_URL=$DATABASE_URL
ENV INDEXER_DATABASE_URL=$INDEXER_DATABASE_URL
ENV S3_ENDPOINT=$S3_ENDPOINT
ENV S3_ACCESS_KEY=$S3_ACCESS_KEY
ENV S3_SECRET_KEY=$S3_SECRET_KEY
ENV SES_REGION=$SES_REGION
ENV SES_ACCESS_KEY=$SES_ACCESS_KEY
ENV SES_SECRET_KEY=$SES_SECRET_KEY
ENV SES_MAIL_FROM=$SES_MAIL_FROM
ENV VITE_LIVE_API_KEY=$VITE_LIVE_API_KEY
ENV BYPASS_LIVE_KEY=$BYPASS_LIVE_KEY
ENV VITE_PRIVY_APP_ID=$VITE_PRIVY_APP_ID
ENV PRIVY_APP_SECRET=$PRIVY_APP_SECRET
ENV REDIS_URL=$REDIS_URL

COPY --from=prune /app/out/full/ .
RUN pnpm run build

# runner
FROM base AS runner

ENV NODE_ENV=production

RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nodejs
USER nodejs

COPY --from=prod --chown=nodejs:nodejs /app/ .
COPY --from=build --chown=nodejs:nodejs /app/apps/web-v2/.output ./apps/web-v2/.output

EXPOSE 3000/tcp

CMD ["node", "apps/web-v2/.output/server/index.mjs"]